name: go test

on:
  push:
    tags:
      - v*
    branches:
      - master

  pull_request:

jobs:
  module-matrix:
    name: Go module matrix
    runs-on: ubuntu-latest

    outputs:
      modules: ${{ steps.modules.outputs.modules }}

    steps:
      - uses: actions/checkout@v5
      - name: Find go modules
        id: modules
        shell: bash
        run: |
          # This script finds all go modules declared in this repo and resolves to a relative path to each of those.
          #
          # NOTES:
          #
          # > * git bash on a windows runner should support GNU find. find flags should be supported by find on macos.
          # > * with go.work file enabled, we may now collect all submodules with go list -m
          # >
          # > The outcome is currently only used for linting. Tests may now skip that part.
          set -euxo pipefail

          root="$(git rev-parse --show-toplevel)"
          cd "${root}"

          declare -i index=0
          declare -a all_mods
          printf "modules=[" >> "$GITHUB_OUTPUT"
          while read module_location ; do
            if [ $index -gt 0 ] ; then
              printf "," >> "$GITHUB_OUTPUT"
            fi
            relative_location=${module_location#"$root"/}
            module_dir=${relative_location%"/go.mod"}
            base_dir="${module_dir#"./"}"
            printf " \"${base_dir}\"" >> "$GITHUB_OUTPUT"
            all_mods+=("${base_dir}")
            ((index++)) || true
          done < <(go list -f '{{.Dir}}' -m)
          printf "]" >> "$GITHUB_OUTPUT"

          echo "::notice title=Modules found::${all_mods[@]}"

  module-lint:
    name: Go module lint
    runs-on: ubuntu-latest
    needs: [ module-matrix ]

    strategy:
      matrix:
        # all sub modules in this repo must be linted separately
        module: ${{ fromJSON(needs.module-matrix.outputs.modules) }}

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          only-new-issues: true
          skip-cache: true
          # golangci-lint doesn't support go.work to lint multiple modules in one single pass
          working-directory: '${{ matrix.module }}'

  lint:
    needs: [ module-lint ]
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Linting complete
        run: |
          echo "All modules linted"

  module-test:
    name: Unit tests
    runs-on: ${{ matrix.os }}
    needs: [ module-matrix ]

    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
        go_version: ['oldstable', 'stable' ]

    steps:
    - uses: actions/checkout@v5
    #- name: Ensure cache is available
    # run: |
    #   mkdir -p /home/runner/go/pkg/mod
    #   mkdir -p /home/runner/.cache/go.build
    - uses: actions/setup-go@v6
      with:
        go-version: '${{ matrix.go_version }}'
        check-latest: true
        cache: true
        cache-dependency-path: '**/go.sum'

    - name: Run unit tests on all modules in this repo
      shell: bash
      env:
        # *.coverage.* pattern is automatically detected by codecov
        COVER_PROFILE:  'all_modules.coverage.${{ matrix.os }}.${{ matrix.go_version }}.out'
      run: |
        declare -a ALL_MODULES
        BASH_MAJOR=$(echo $BASH_VERSION|cut -d'.' -f1)
        if [[ "${BASH_MAJOR}" -ge 4 ]] ; then
          mapfile ALL_MODULES < <(go list -f '{{.Dir}}/...' -m)
        else
          # for older bash versions, e.g. on macOS runner. This fallback will eventually disappear.
          while read line ; do
            ALL_MODULES+=("${line}")
          done < <(go list -f '{{.Dir}}/...' -m)
        fi
        echo "::notice title=Modules found::${ALL_MODULES[@]}"

        # with go.work file enabled, go test recognizes sub-modules and collects all packages to be covered
        # without specifying -coverpkg.
        go test -v -race -coverprofile="${COVER_PROFILE}" -covermode=atomic ${ALL_MODULES[@]}

    - name: Upload coverage to codecov
      uses: codecov/codecov-action@v5
      with:
        name: Multi modules aggregated coverage
        flags: '${{ matrix.go_version }}-${{ matrix.os }}'
        fail_ci_if_error: false
        verbose: true

  test:
    needs: [ module-test ]
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Tests complete
        run: |
          echo "All tests completed"
